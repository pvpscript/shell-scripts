#!/bin/sh
#
# A script to dismount mounted partitions

EXCLUDE="$(echo "${@:-sda}" | sed 's/\(sd.[0-9]*\) \+/(\1)|/g;s/\(sd.[0-9]*\)$/(\1)/g')"

SIZE_PADDING=$(lsblk -rn --paths -o SIZE | awk '{ printf "%s\n", length($1) }' | sort -r -n | head -1)
NAME_PADDING=$(lsblk -rn --paths -o NAME | awk '{ printf "%s\n", length($1)+2 }' | sort -r -n | head -1)
# length($1)+2 for the characters '[' and ']' in the printf below

mntd=$(lsblk -rn --paths -o SIZE,NAME,MOUNTPOINT |
	while IFS= read -r line;
	do
		set -- $line
		if [ -n "$3" ];
		then
			echo "$2" | grep -qiE "$EXCLUDE"
			[ $? -eq 1 ] && printf "%-*s - %-*s -> %s\n" $SIZE_PADDING "$1" $NAME_PADDING "[$2]" "$3"
		fi
	done | dmenu -p "Dismount a partition" -l 20)

[ -n "$mntd" ] && sudo umount "$(echo "$mntd" | sed 's/.*\[\(.*\)\].*/\1/')"

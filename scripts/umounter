#!/bin/sh

# A script to dismount mounted partitions
#
# Caveats: Code not really maintainable.
# If one wish to increase the number of fields of the 'lsblk' command,
# make sure to also rebuild the regex on the 'sed' command below so it
# matches the new fields

EXCLUDE="$(echo "${@:-sda}" | sed 's/\(sd.[0-9]*\) \+/(\1)|/g;s/\(sd.[0-9]*\)$/(\1)/g')"

SIZE_PADDING=$(lsblk -prn -o SIZE,MOUNTPOINT | awk '{ if (length($2) > 0) printf "%s\n", length($1) }' | sort -rn | head -1)
MNT_PADDING=$(lsblk -prn -o MOUNTPOINT | awk '{ printf "%s\n", length($1) }' | sort -rn | head -1)
NAME_PADDING=$(lsblk -prn -o NAME,MOUNTPOINT | awk '{ if (length($2) > 0) printf "%s\n", length($1)+2 }' | sort -rn | head -1)
# length($1)+2 for the characters '[' and ']' in the printf below

mntd=$(lsblk -Ppn -o SIZE,NAME,MOUNTPOINT,LABEL |
	while IFS= read -r line;
	do
		IFS='
		'
		set -- $(echo $line | sed 's/.*="\(.*\)" \+.*="\(.*\)" \+.*="\(.*\)" \+.*="\(.*\)"/\1\n\2\n\3\n\4/') 

		if [ -n "$3" ];
		then
			[ -n "$4" ] && label="$(printf " (%b)" "$4")" || label=""
			echo "$2" | grep -qiE "$EXCLUDE"
			[ $? -eq 1 ] && printf "%-*s - %-*s -> %-*s%s\n" \
				$SIZE_PADDING "$1" \
				$NAME_PADDING "[$2]" \
				$MNT_PADDING "$3" \
				"$label"
		fi
	done | dmenu -p "Dismount a partition" -l 20)

[ -n "$mntd" ] && sudo umount "$(echo "$mntd" | sed 's/.*\[\(.*\)\].*/\1/')"
